{% if mce_config.inline %}
    <div{{ attrs }}>{{ value }}</div>
{% else %}
    <textarea{{ attrs }}>{{ value }}</textarea>

    <input id="django-upload-input-{{ id }}" name="image" type="file" style="width:0; height:0; overflow:hidden;" />
    <script type="text/javascript">
        (function(){
            // fetch input from DOM 
            var $ = django.jQuery;
            var $input = $('#django-upload-input-{{ id }}');

            $input.on('change',function(e){
                var file = e.target.files[0];
                if(-1 === file.type.indexOf('image')){
                    return alert("Invalid image");
                }
                var reader = new FileReader();
                reader.onload = function(e){
                    var html = '<img src="'+ e.target.result +'" />';
                    tinymce.activeEditor.insertContent(html);
                    $('.mce-window').find('.mce-primary').click(); // close popup

                    // TODO disable form submit
                    tinymce.activeEditor.uploadImages(function(success) {
                        // TODO re-enable form submit
                    });

                };
                reader.readAsDataURL(file);
                $input.val(''); // empty the input value
            });    
            
            // augment tinymce configuration
            var data = {{ mce_json | safe }}; 
            data['file_browser_callback'] = fileBrowserCallback; 
            data['paste_postprocess'] = onPasteCallback;
            tinyMCE.init(data);
            
            // client-side callback
            function fileBrowserCallback(){
                // open native file picker
                $input.trigger('click');       
            }

            // paste callback
            function onPasteCallback(){
                setTimeout(function(){
                    // TODO disable form submit
                    tinymce.activeEditor.uploadImages(function(success) {
                        // TODO re-enable form submit
                    });
                }, 500);
            }

        })();
    </script>

{% endif %}

